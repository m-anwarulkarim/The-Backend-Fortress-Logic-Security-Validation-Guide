## ЁЯФР Role-Based Auth Middleware (Better Auth + Express)

### ЁЯОп ржХрзА ржХрзА ржХрж░ржмрзЗ

- user logged in ржХрж┐ржирж╛ check
- email verified ржХрж┐ржирж╛ check
- user ржПрж░ role match ржХрж░рзЗ ржХрж┐ржирж╛ check
- flexible (admin / user / manager ржЗрждрзНржпрж╛ржжрж┐)

---

## тЬЕ `auth.middleware.ts`

```ts
import { auth } from "../lib/auth";
import { Request, Response, NextFunction } from "express";

type ROLE = "admin" | "manager" | "user";

const ROLE_LEVEL: Record<ROLE, number> = {
  admin: 3,
  manager: 2,
  user: 1,
};

type GuardOptions = {
  roles?: ROLE[];
  requireVerified?: boolean;
};

const deny = (res: Response, status: number, message: string) =>
  res.status(status).json({ success: false, message });

export const authGuard =
  (options: GuardOptions = {}) =>
  async (req: Request, res: Response, next: NextFunction) => {
    try {
      const session = await auth.api.getSession({
        headers: req.headers,
      });

      if (!session?.user) {
        return deny(res, 401, "Unauthorized: Login required");
      }

      const userRole: ROLE = session.user.role ?? "user";

      if (options.requireVerified !== false && !session.user.emailVerified) {
        return deny(res, 403, "Email not verified");
      }

      if (options.roles?.length) {
        const userLevel = ROLE_LEVEL[userRole];
        const requiredLevel = Math.max(
          ...options.roles.map((r) => ROLE_LEVEL[r])
        );

        if (userLevel < requiredLevel) {
          return deny(res, 403, "Access denied: insufficient role");
        }
      }

      req.user = {
        id: session.user.id,
        email: session.user.email,
        role: userRole,
      };

      next();
    } catch (error) {
      console.error("Auth middleware error:", error);
      return deny(res, 500, "Internal server error");
    }
  };
```

ржирж┐ржЪрзЗ рж╕рж╣ржЬ ржмрж╛ржВрж▓рж╛рзЯ ржПрж░ ржкрзНрж░рждрж┐ржЯрж┐ ржЕржВрж╢рзЗрж░ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ:

### рзз. Role ржПржмржВ Permission рж╕рзЗржЯржЖржк

ржХрзЛржбрзЗрж░ рж╢рзБрж░рзБрждрзЗ ржЗржЙржЬрж╛рж░ржжрзЗрж░ ржЬржирзНржп рждрж┐ржиржЯрж┐ рж░рзЛрж▓ (Role) ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржПржмржВ рждрж╛ржжрзЗрж░ ржПржХржЯрж┐ **ржкрж╛ржУрзЯрж╛рж░ рж▓рзЗржнрзЗрж▓** ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗ:

- **Admin:** рж▓рзЗржнрзЗрж▓ рзй (рж╕ржмржЪрзЗрзЯрзЗ ржмрзЗрж╢рж┐ ржХрзНрж╖ржорждрж╛)
- **Manager:** рж▓рзЗржнрзЗрж▓ рзи
- **User:** рж▓рзЗржнрзЗрж▓ рзз

```ts
const ROLE_LEVEL: Record<ROLE, number> = {
  admin: 3,
  manager: 2,
  user: 1,
};
```

ржПрж░ ржлрж▓рзЗ ржХрзЛржб ржжрж┐рзЯрзЗ рж╕рж╣ржЬрзЗржЗ рждрзБрж▓ржирж╛ ржХрж░рж╛ ржпрж╛рзЯ ржпрзЗ ржПржХржЬржи ржЗржЙржЬрж╛рж░рзЗрж░ ржХрж┐ ржХрзЛржирзЛ ржЕрзНржпрж╛ржХрж╢ржи ржирзЗржУрзЯрж╛рж░ ржЕржирзБржорждрж┐ ржЖржЫрзЗ ржХрж┐ ржирж╛ред

### рзи. `deny` ржлрж╛ржВрж╢ржи

ржПржЯрж┐ ржПржХржЯрж┐ рж╣рзЗрж▓рзНржкрж╛рж░ ржлрж╛ржВрж╢ржиред ржпржЦржиржЗ ржХрзЛржирзЛ ржЗржЙржЬрж╛рж░ржХрзЗ ржерж╛ржорж┐рзЯрзЗ ржжрзЗржУрзЯрж╛рж░ ржкрзНрж░рзЯрзЛржЬржи рж╣рзЯ (ржпрзЗржоржи: рж▓ржЧржЗржи ржирж╛ ржерж╛ржХрж▓рзЗ ржмрж╛ ржкрж╛рж░ржорж┐рж╢ржи ржирж╛ ржерж╛ржХрж▓рзЗ), ржПржЗ ржлрж╛ржВрж╢ржиржЯрж┐ ржПржХржЯрж┐ рж╕рзБржирзНржжрж░ JSON ржПрж░рж░ ржорзЗрж╕рзЗржЬ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗред

### рзй. `authGuard` (ржкрзНрж░ржзрж╛ржи ржЕржВрж╢)

ржПржЯрж┐ ржПржХржЯрж┐ Middlewareред ржПржЯрж┐ рждрж┐ржиржЯрж┐ ржкрзНрж░ржзрж╛ржи ржХрж╛ржЬ ржХрж░рзЗ:

**ржХ. рж╕рзЗрж╢ржи ржЪрзЗржХ (Authentication):**

```ts
const session = await auth.api.getSession({ headers: req.headers });
if (!session?.user) {
  return deny(res, 401, "Unauthorized: Login required");
}
```

ржкрзНрж░ржержорзЗ ржЪрзЗржХ ржХрж░рзЗ ржЗржЙржЬрж╛рж░рзЗрж░ ржХрж╛ржЫрзЗ ржмрзИржз рж╕рзЗрж╢ржи ржмрж╛ ржЯрзЛржХрзЗржи ржЖржЫрзЗ ржХрж┐ ржирж╛ред ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ, рждржмрзЗ рж╕рзЗржЦрж╛ржирзЗржЗ рждрж╛ржХрзЗ ржЖржЯржХрзЗ ржжрзЗрзЯ (Error 401)ред

**ржЦ. ржЗржорзЗржЗрж▓ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи ржЪрзЗржХ:**
ржпржжрж┐ ржЖржкржирж┐ ржЪрж╛ржи ржпрзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЗржорзЗржЗрж▓ ржнрзЗрж░рж┐ржлрж╛ржЗржб ржЗржЙржЬрж╛рж░рж░рж╛ржЗ ржврзБржХрждрзЗ ржкрж╛рж░ржмрзЗ, рждржмрзЗ ржПржЯрж┐ рж╕рзЗржЗ ржЪрзЗржХржЯрж┐ ржХрж░рзЗред ржпржжрж┐ ржЗржорзЗржЗрж▓ ржнрзЗрж░рж┐ржлрж╛ржЗржб ржирж╛ ржерж╛ржХрзЗ, рждржмрзЗ 'Email not verified' ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛рзЯред

**ржЧ. рж░рзЛрж▓ ржмрж╛ ржкрж╛рж░ржорж┐рж╢ржи ржЪрзЗржХ (Authorization):**
ржПржЦрж╛ржирзЗржЗ ржорзВрж▓ ржорзНржпрж╛ржЬрж┐ржХ ржШржЯрзЗред ржпржжрж┐ ржЖржкржирж┐ ржмрж▓рзЗ ржжрзЗржи ржпрзЗ ржПржЗ рж░рж╛ржЙржЯржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ 'Admin' ржПрж░ ржЬржирзНржп, рждржмрзЗ ржПржЯрж┐ ржЗржЙржЬрж╛рж░рзЗрж░ рж▓рзЗржнрзЗрж▓ ржЪрзЗржХ ржХрж░рзЗред

- ржзрж░рж╛ ржпрж╛ржХ, ржПржХржЯрж┐ рж░рж╛ржЙржЯрзЗрж░ ржЬржирзНржп **Admin** ржкрзНрж░рзЯрзЛржЬржи (рж▓рзЗржнрзЗрж▓ рзй)ред
- ржХрж┐ржирзНрждрзБ ржПржХржЬржи **Manager** (рж▓рзЗржнрзЗрж▓ рзи) рж╕рзЗржЦрж╛ржирзЗ ржврзЛржХрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░ржЫрзЗред
- ржпрзЗрж╣рзЗрждрзБ рзи, рзй ржПрж░ ржЪрзЗрзЯрзЗ ржЫрзЛржЯ, рждрж╛ржЗ рждрж╛ржХрзЗ ржврзБржХрждрзЗ ржжрзЗржмрзЗ ржирж╛ред

### рзк. ржбрж╛ржЯрж╛ ржкрж╛рж╕ ржХрж░рж╛

ржпржжрж┐ рж╕ржмржХрж┐ржЫрзБ ржарж┐ржХ ржерж╛ржХрзЗ, рждржмрзЗ ржПржЯрж┐ `req.user` ржПрж░ ржоржзрзНржпрзЗ ржЗржЙржЬрж╛рж░рзЗрж░ ржкрзНрж░рзЯрзЛржЬржирзАрзЯ рждржерзНржпржЧрзБрж▓рзЛ (ID, Email, Role) ржнрж░рзЗ ржжрзЗрзЯред ржПрж░ ржлрж▓рзЗ ржкрж░ржмрж░рзНрждрзА ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛрждрзЗ ржЖржкржирж╛ржХрзЗ ржЖрж░ ржмрж╛рж░ржмрж╛рж░ ржбрж╛ржЯрж╛ржмрзЗрж╕ ржХрж▓ ржХрж░рждрзЗ рж╣ржмрзЗ ржирж╛, ржЖржкржирж┐ рж╕рж░рж╛рж╕рж░рж┐ `req.user` ржерзЗржХрзЗржЗ рждржерзНржп ржкрж╛ржмрзЗржиред

рж╕ржмрж╢рзЗрж╖рзЗ `next()` ржХрж▓ ржХрж░рж╛рж░ ржорж╛ржзрзНржпржорзЗ ржЗржЙржЬрж╛рж░ржХрзЗ рждрж╛рж░ ржЧржирзНрждржмрзНржпрзЗ (Route Handler) ржпрж╛ржУрзЯрж╛рж░ ржЕржирзБржорждрж┐ ржжрзЗржУрзЯрж╛ рж╣рзЯред

## ЁЯза Role Field ржХрзЛржерж╛ ржерзЗржХрзЗ ржЖрж╕ржмрзЗ?

Better Auth user model ржП **role** ржерж╛ржХрждрзЗ рж╣ржмрзЗ:

```ts
// example user object
{
  id: "uuid",
  email: "user@email.com",
  emailVerified: true,
  role: "admin" | "user"
}
```

ЁЯСЙ ржирж╛ ржерж╛ржХрж▓рзЗ default рж╣рж┐рж╕рзЗржмрзЗ `user` рж░рж╛ржЦрзЛред

---

## ЁЯЫб TypeScript Fix (`express.d.ts`)

```ts
declare global {
  namespace Express {
    interface Request {
      user?: {
        id: string;
        email: string;
        role: string;
        emailVerified: boolean;
      };
    }
  }
}
```

---

## ЁЯФР Usage Example

```ts
router.get("/user", authGuard(), controller.me);

router.post("/user", authGuard({ roles: ["admin"] }), controller.admin);

router.post("/user", authGuard({ roles: ["manager"] }), controller.manage);
```

ржирж┐ржЪрзЗ ржкрзНрж░рждрж┐ржЯрж┐ рж▓рж╛ржЗржирзЗрж░ ржХрж╛ржЬ рж╕рж╣ржЬржнрж╛ржмрзЗ ржмрзБржЭрж┐рзЯрзЗ ржмрж▓рж╛ рж╣рж▓рзЛ:

---

### рзз. рж╕рж╛ржзрж╛рж░ржг ржЗржЙржЬрж╛рж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓ рж░рж╛ржЙржЯ

```ts
router.get("/user", authGuard(), controller.me);
```

- **ржПржЦрж╛ржирзЗ ржХрзА рж╣ржЪрзНржЫрзЗ?**: ржПржЦрж╛ржирзЗ `authGuard()`-ржПрж░ ржнрзЗрждрж░рзЗ ржХрзЛржирзЛ рж╕рзНржкрзЗрж╢рж╛рж▓ рж╢рж░рзНржд (roles) ржжрзЗржУрзЯрж╛ рж╣рзЯржирж┐ред
- **ржХрж╛рж░рж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржкрж╛ржмрзЗ?**: ржпрзЗржХрзЛржирзЛ **рж▓ржЧржЗржи ржХрж░рж╛ ржЗржЙржЬрж╛рж░** (рж╕рзЗ admin рж╣рзЛржХ ржмрж╛ рж╕рж╛ржзрж╛рж░ржг user) ржПржЗ рж░рж╛ржЙржЯржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗред
- **ржХрж╛ржЬ**: рж╕рж╛ржзрж╛рж░ржгржд ржирж┐ржЬрзЗрж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржжрзЗржЦрж╛рж░ ржЬржирзНржп ржПржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ рж╣рзЯред

### рзи. рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржбржорж┐ржи рж░рж╛ржЙржЯ

```ts
router.post("/user", authGuard({ roles: ["admin"] }), controller.admin);
```

- **ржПржЦрж╛ржирзЗ ржХрзА рж╣ржЪрзНржЫрзЗ?**: ржЖржорж░рж╛ ржЕржкрж╢ржи рж╣рж┐рж╕рзЗржмрзЗ `{ roles: ["admin"] }` ржжрж┐рзЯрзЗржЫрж┐ред
- **ржХрж╛рж░рж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржкрж╛ржмрзЗ?**: рж╢рзБржзрзБржорж╛рждрзНрж░ ржпрж╛ржжрзЗрж░ ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯрзЗрж░ рж░рзЛрж▓ **"admin"**ред
- **ржХрзА ржШржЯржмрзЗ?**: ржпржжрж┐ ржПржХржЬржи рж╕рж╛ржзрж╛рж░ржг ржЗржЙржЬрж╛рж░ ржмрж╛ ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржПржЦрж╛ржирзЗ ржврзЛржХрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзЗ, рждржмрзЗ ржЖржкржирж╛рж░ ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░ рждрж╛ржХрзЗ `403 Forbidden` ржПрж░рж░ ржжрзЗржмрзЗ ржПржмржВ ржмрж▓ржмрзЗ "insufficient role"ред

### рзй. ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржмрж╛ рждрж╛рж░ ржЙржкрж░рзЗрж░ рж▓рзЗржнрзЗрж▓рзЗрж░ рж░рж╛ржЙржЯ

```ts
router.post("/user", authGuard({ roles: ["manager"] }), controller.manage);
```

- **ржПржЦрж╛ржирзЗ ржХрзА рж╣ржЪрзНржЫрзЗ?**: ржПржЦрж╛ржирзЗ рж░рж┐ржХрзЛрзЯрж╛рж░рзНржб рж░рзЛрж▓ рж╣рж▓рзЛ **"manager"**ред
- **ржХрж╛рж░рж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржкрж╛ржмрзЗ?**: ржПржЗ ржЬрж╛рзЯржЧрж╛ржЯрж┐ ржПржХржЯрзБ ржоржи ржжрж┐рзЯрзЗ ржмрзБржЭрзБржиред ржЖржкржирж╛рж░ ржХрзЛржбрзЗ ржпрзЗрж╣рзЗрждрзБ **ROLE_LEVEL** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ:
- **Manager** (рж▓рзЗржнрзЗрж▓ рзи) ржПржЯрж┐ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗред
- **Admin** (рж▓рзЗржнрзЗрж▓ рзй) ржПржЯрж┐ ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ, ржХрж╛рж░ржг ржПржбржорж┐ржирзЗрж░ рж▓рзЗржнрзЗрж▓ ржорзНржпрж╛ржирзЗржЬрж╛рж░рзЗрж░ ржЪрзЗрзЯрзЗ ржмрзЗрж╢рж┐ред

- **ржХрж╛ржЬ**: ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ рж▓рзЗржнрзЗрж▓рзЗрж░ ржХрзЛржирзЛ ржХрж╛ржЬрзЗрж░ ржЬржирзНржп ржПржЯрж┐ ржмрзНржпржмрж╣рзГржд рж╣рзЯред

---

### рж╕ржВржХрзНрж╖рзЗржкрзЗ рждрзБрж▓ржирж╛:

| рж░рж╛ржЙржЯ (Route)           | ржкрзНрж░рзЯрзЛржЬржирзАрзЯрждрж╛ (Requirement) | ржХрж╛рж░рж╛ ржврзБржХрждрзЗ ржкрж╛рж░ржмрзЗ?    |
| ---------------------- | ------------------------- | -------------------- |
| `GET /user`            | рж╢рзБржзрзБ рж▓ржЧржЗржи ржерж╛ржХрж▓рзЗржЗ рж╣ржмрзЗ      | User, Manager, Admin |
| `POST /user` (Admin)   | ржЕржмрж╢рзНржпржЗ Admin рж╣рждрзЗ рж╣ржмрзЗ      | Admin ржорж╛рждрзНрж░          |
| `POST /user` (Manager) | ржЕржирзНрждржд Manager рж╣рждрзЗ рж╣ржмрзЗ     | Manager ржПржмржВ Admin    |

---

### ржПржХржЯрж┐ ржЫрзЛржЯ ржЯрж┐ржкрж╕:

ржХрзЛржбрзЗ `Math.max` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ `requiredLevel` ржмрзЗрж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред ржПрж░ рж╕рзБржмрж┐ржзрж╛ рж╣рж▓рзЛ, ржЪрж╛ржЗрж▓рзЗ ржнржмрж┐рж╖рзНржпрждрзЗ ржХрзЛржирзЛ рж░рж╛ржЙржЯрзЗ ржПржХрж╛ржзрж┐ржХ рж░рзЛрж▓ ржжрж┐рждрзЗ ржкрж╛рж░рзЗржи, ржпрзЗржоржи:
`authGuard({ roles: ["user", "manager"] })`
рждржЦржи рж╕рж┐рж╕рзНржЯрзЗржо ржЪрзЗржХ ржХрж░ржмрзЗ ржПржЗ рж▓рж┐рж╕рзНржЯрзЗрж░ ржоржзрзНржпрзЗ рж╕рж░рзНржмрзЛржЪрзНржЪ рж▓рзЗржнрзЗрж▓ ржХрж╛рж░, ржПржмржВ рж╕рзЗржЗ ржЕржирзБржпрж╛рзЯрзА ржкрж╛рж░ржорж┐рж╢ржи ржжрж┐ржмрзЗред

## тЬЕ Security Coverage

тЬФ Session-based auth (Better Auth)
тЬФ Email verification enforced
тЬФ Role-based access control
тЬФ Scalable & reusable
тЬФ Clean error responses

---

ржЪрж╛ржУ рждрзЛ ржЖржорж┐ next ржжрзЗржЦрж╛рждрзЗ ржкрж╛рж░рж┐ ЁЯСЗ

- ЁЯФБ multi-role hierarchy (admin > manager > user)
- ЁЯФР permission-based system (read/write/delete)

ржпрзЗржЯрж╛ ржжрж░ржХрж╛рж░ ржмрж▓рзЛ ЁЯСН
