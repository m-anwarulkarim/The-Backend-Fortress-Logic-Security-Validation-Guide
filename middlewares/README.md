# ЁЯЫбя╕П Middlewares Layer (ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржУ ржкрж╛рж╣рж╛рж░рж╛ржжрж╛рж░ рж╕рзНрждрж░)

## ЁЯУМ ржкрж░рж┐ржЪрж┐рждрж┐

ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░ рж╣рж▓рзЛ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржПржХржЯрж┐ **"ржЪрзЗржХржкрзЛрж╕рзНржЯ"**ред ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржерзЗржХрзЗ ржЖрж╕рж╛ ржкрзНрж░рждрж┐ржЯрж┐ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ **Controller**-ржП ржпрж╛ржУржпрж╝рж╛рж░ ржЖржЧрзЗ ржПржЗ рж╕рзНрждрж░ ржЕрждрж┐ржХрзНрж░ржо ржХрж░рзЗред ржПрж░ ржХрж╛ржЬ рж╣рж▓рзЛтАФ

- ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛
- ржнрзБрж▓/ржЕрж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржмрзНрж▓ржХ ржХрж░рж╛
- рж╕рж┐рж╕рзНржЯрзЗржоржХрзЗ ржЕржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рж▓рзЛржб ржерзЗржХрзЗ рж░ржХрзНрж╖рж╛ ржХрж░рж╛

ржирж┐ржЪрзЗ **Auth Guard** ржпрзЗ ржкрзНрж░ржзрж╛ржи рзнржЯрж┐ ржзрж╛ржк ржЕржирзБрж╕рж░ржг ржХрж░рзЗ рждрж╛ ржжрзЗржЦрж╛ржирзЛ рж╣рж▓рзЛ (ржкрзНрж░рзЯрзЛржЬржирзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржкрж╛рж░рзЗржи) рж╕рж╛ржерзЗ рж░рзЯрзЗржЫрзЗ **req.user** ржЯрж╛ржЗржк ржбрж┐ржХрзНрж▓рзЗрзЯрж╛рж░, _Usage in Routes_, **Logout ржХрж░рзЗ ржЯрзЛржХрзЗржи blacklist ржХрж░рж╛** , _`checkRedisBlacklist()` ржлрж╛ржВрж╢ржи_:

---

## ЁЯФР Auth Guard-ржПрж░ рзнржЯрж┐ ржзрж╛ржк

1. **ржЯрзЛржХрзЗржи ржЧрзНрж░рж╣ржг (Token Extraction)**  
   рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╣рзЗржбрж╛рж░рзЗрж░ `Authorization: Bearer <token>` ржерзЗржХрзЗ ржЯрзЛржХрзЗржи рж╕ржВржЧрзНрж░рж╣ ржХрж░рж╛ред

2. **ржЯрзЛржХрзЗржи ржЙржкрж╕рзНржерж┐рждрж┐ ржЪрзЗржХ (Presence Check)**  
   ржЯрзЛржХрзЗржи ржирж╛ ржерж╛ржХрж▓рзЗ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржмржирзНржз ржХрж░рж╛ рж╣рзЯред  
   **Status:** `401 Unauthorized`

3. **ржЯрзЛржХрзЗржи ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи (Token Verification)**  
   Server-ржПрж░ JWT Secret ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛ рж╣рзЯ ржЯрзЛржХрзЗржиржЯрж┐ ржмрзИржз ржХрж┐ ржирж╛ред

4. **ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗржб ржЯрзЛржХрзЗржи ржЪрзЗржХ (Blacklist Check)**  
   рж▓ржЧржЖржЙржЯ ржХрж░рж╛ ржЯрзЛржХрзЗржи Redis-ржПрж░ ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗ ржерж╛ржХрзЗред  
   ржЯрзЛржХрзЗржиржЯрж┐ ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗ ржерж╛ржХрж▓рзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржмрж╛рждрж┐рж▓ред

5. **ржЗржЙржЬрж╛рж░рзЗрж░ ржЕрж╕рзНрждрж┐рждрзНржм ржпрж╛ржЪрж╛ржЗ (User Existence Check)**  
   ржЯрзЛржХрзЗржи Valid рж╣рж▓рзЗржУ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржЗржЙржЬрж╛рж░ ржЦрзБржБржЬрзЗ ржжрзЗржЦрж╛ рж╣рзЯ ржпрзЗ ржЗржЙржЬрж╛рж░ ржПржЦржирзЛ Active ржЖржЫрзЗ ржХрж┐ ржирж╛ред

6. **рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯрзЗ ржбрзЗржЯрж╛ рж╕рзЗржЯ ржХрж░рж╛ (Attach User to Request)**  
   рж╕ржмржХрж┐ржЫрзБ ржарж┐ржХ рж╣рж▓рзЗ ржЗржЙржЬрж╛рж░рзЗрж░ рждржерзНржп `req.user` ржП рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯред

7. **рж░рзЛрж▓-ржмрзЗрж╕ржб ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХржирзНржЯрзНрж░рзЛрж▓ (RBAC)**  
   ржЗржЙржЬрж╛рж░рзЗрж░ Role (Admin/User/Editor) ржЕржирзБржорждрж┐ ржирж╛ ржерж╛ржХрж▓рзЗ  
   **Status:** `403 Forbidden`

---

## ЁЯзР ржХрзЗржи ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░ ржкрзНрж░рзЯрзЛржЬржи?

1. **ржирж┐рж░рж╛ржкрждрзНрждрж╛ (Authentication)** тАФ ржЗржЙржЬрж╛рж░ рж▓ржЧржЗржи ржХрж░рж╛ ржХрж┐ ржирж╛ ржЪрзЗржХ ржХрж░рж╛ред
2. **ржХрзНрж╖ржорждрж╛ ржпрж╛ржЪрж╛ржЗ (Authorization)** тАФ ржЗржЙржЬрж╛рж░рзЗрж░ ржХрж┐ ржЕржирзБржорждрж┐ ржЖржЫрзЗ рждрж╛ ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛ред
3. **ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи** тАФ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗрж░ ржбрзЗржЯрж╛/ржЯрзЛржХрзЗржи рж╕ржарж┐ржХ ржХрж┐ ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛ред
4. **ржХрзЛржб рж░рж┐ржЗржЙржЬрзЗржмрж┐рж▓рж┐ржЯрж┐** тАФ ржмрж╛рж░ржмрж╛рж░ рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ рж▓ржЬрж┐ржХ ржирж╛ рж▓рж┐ржЦрзЗ ржПржХ ржЬрж╛ржпрж╝ржЧрж╛рзЯ рж░рж╛ржЦрж╛ред

---

## ЁЯЪж Middleware Workflow

```text
Client Request тЮбя╕П Middleware (ржЪрзЗржХржкрзЛрж╕рзНржЯ) тЮбя╕П next() тЮбя╕П Controller
```

# _тЬЕ 1) \*\*рж╕ржорзНржкрзВрж░рзНржг Auth Guard Middleware_

```ts
// src/middleware/authGuard.ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";
import { prisma } from "../lib/prisma";
import { checkRedisBlacklist } from "../utils/redis";

export const authGuard = (...Role: string[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      // рзз. Token Extraction
      const token = req.headers.authorization?.split(" ")[1];
      if (!token) throw new Error("You are not logged in! | ржЖржкржирж┐ рж▓ржЧржЗржи ржХрж░рж╛ ржиржи!");

      // рзи. Blacklist ржЪрзЗржХ (рж▓ржЧржЖржЙржЯ ржмрж╛ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржЪрзЗржЮрзНржЬ рж╣рж▓рзЗ)
      const isBlacklisted = await checkRedisBlacklist(token);
      if (isBlacklisted)
        throw new Error(  "This token has been revoked! | ржПржЗ ржЯрзЛржХрзЗржиржЯрж┐ ржмрж╛рждрж┐рж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ!");

      // рзй. Token Verify
      const decoded = jwt.verify(
        token,
        process.env.JWT_SECRET as string
      ) as any;

      // рзк. User Exists?
      const user = await prisma.user.findUnique({
        where: { id: decoded.id },
        select: { id: true, role: true, isBanned: true } // рж╢рзБржзрзБ ржпрж╛ ржжрж░ржХрж╛рж░ рждрж╛ ржЖржирзБржи
      });

      if (!user) throw new Error("User not found! | ржЗржЙржЬрж╛рж░ржЯрж┐ ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐!");
      if (user.isBanned)
        throw new Error( "Your account has been suspended! | ржЖржкржирж╛рж░ ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯржЯрж┐ рж╕рзНржержЧрж┐ржд ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ!");

      // рзл. Role Check
      if (Role.length > 0 && !Role.includes(user.role)) {
        return res.status(403).json({
          success: false,
          message: "Access forbidden! You do not have permission | ржПржЗ рж░рзБржЯрзЗ ржЖржкржирж╛рж░ ржкрзНрж░ржмрзЗрж╢рж╛ржзрж┐ржХрж╛рж░ ржирзЗржЗ!",
        });
      }

      // рзм. Attach user to req
      req.user = user;

      next();
    } catch (error: any) {
      res.status(401).json({
        success: false,
        message: error.message || "Authentication failed! | ржЕржерзЗржирзНржЯрж┐ржХрзЗрж╢ржи ржмрзНржпрж░рзНрже рж╣рзЯрзЗржЫрзЗ!",,
      });
    }
  };
};
```

ржирж┐ржЪрзЗ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ ржПрж░ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ:

---

### рзз. ржЯрзЛржХрзЗржи рж╕ржВржЧрзНрж░рж╣ (Token Extraction)

```ts
const token = req.headers.authorization?.split(" ")[1];
```

- ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржпржЦржи рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛рзЯ, рждржЦржи `Authorization` рж╣рзЗржбрж╛рж░ ржерзЗржХрзЗ ржЯрзЛржХрзЗржиржЯрж┐ рж╕ржВржЧрзНрж░рж╣ ржХрж░рж╛ рж╣рзЯред рж╕рж╛ржзрж╛рж░ржгржд ржПржЯрж┐ `Bearer <token>` ржлрж░ржорзНржпрж╛ржЯрзЗ ржерж╛ржХрзЗ, рждрж╛ржЗ `split(" ")[1]` ржжрж┐рзЯрзЗ рж╢рзБржзрзБ ржЯрзЛржХрзЗржи ржЕржВрж╢ржЯрж┐ ржирзЗржУрзЯрж╛ рж╣рзЯред ржЯрзЛржХрзЗржи ржирж╛ ржерж╛ржХрж▓рзЗ ржПрж░рж░ ржерзНрж░рзЛ ржХрж░рзЗред

### рзи. ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯ ржЪрзЗржХ (Redis Blacklist Check)

```ts
const isBlacklisted = await checkRedisBlacklist(token);
```

- ржПржЯрж┐ ржЕрждрзНржпржирзНржд ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред ржЗржЙржЬрж╛рж░ ржпржжрж┐ ржЖржЧрзЗ рж▓ржЧржЖржЙржЯ ржХрж░рзЗ ржерж╛ржХрзЗ, рждржмрзЗ рждрж╛рж░ ржЯрзЛржХрзЗржиржЯрж┐ Redis-ржП ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯ рж╣рж┐рж╕рзЗржмрзЗ ржЬржорж╛ ржерж╛ржХрзЗред ржпржжрж┐ ржЯрзЛржХрзЗржиржЯрж┐ ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ, рждржмрзЗ рждрж╛ржХрзЗ ржЖрж░ ржврзБржХрждрзЗ ржжрзЗржУрзЯрж╛ рж╣рзЯ ржирж╛ред

### рзй. ржЯрзЛржХрзЗржи ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи (Token Verify)

```ts
const decoded = jwt.verify(token, process.env.JWT_SECRET as string) as any;
```

- ржПржЦрж╛ржирзЗ `jsonwebtoken` рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЪрзЗржХ ржХрж░рж╛ рж╣рзЯ ржпрзЗ ржЯрзЛржХрзЗржиржЯрж┐ ржЖрж╕рж▓ ржХрж┐ ржирж╛ ржПржмржВ ржПрж░ ржорзЗрзЯрж╛ржж ржЖржЫрзЗ ржХрж┐ ржирж╛ред ржЯрзЛржХрзЗржи рж╕ржарж┐ржХ рж╣рж▓рзЗ ржПржЯрж┐ ржбрж┐ржХрзЛржб ржХрж░рзЗ ржЗржЙржЬрж╛рж░рзЗрж░ `id` ржЙржжрзНржзрж╛рж░ ржХрж░рзЗред

### рзк. ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржЗржЙржЬрж╛рж░рзЗрж░ ржЕрж╕рзНрждрж┐рждрзНржм ржпрж╛ржЪрж╛ржЗ (User Check)

```ts
const user = await prisma.user.findUnique({ ... });

```

- ржЯрзЛржХрзЗржи рж╕ржарж┐ржХ рж╣рж▓рзЗржУ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржЧрж┐рзЯрзЗ ржЪрзЗржХ ржХрж░рж╛ рж╣рзЯ ржпрзЗ рж╕рзЗржЗ ржЗржЙржЬрж╛рж░ржЯрж┐ ржПржЦржиржУ ржЖржЫрзЗ ржХрж┐ ржирж╛ред ржПржХржЗ рж╕рж╛ржерзЗ ржЗржЙржЬрж╛рж░ **Banned** ржХрж┐ ржирж╛ рждрж╛ржУ ржЪрзЗржХ ржХрж░рж╛ рж╣рзЯред ржпржжрж┐ ржЗржЙржЬрж╛рж░ ржмрзНржпрж╛ржи ржерж╛ржХрзЗ, рждржмрзЗ рждрж╛ржХрзЗ рж░рж┐ржЬрзЗржХрзНржЯ ржХрж░рж╛ рж╣рзЯред

### рзл. рж░рзЛрж▓рзЗ ржмрж╛ ржЕржирзБржорждрж┐ ржпрж╛ржЪрж╛ржЗ (Role Check)

```ts
if (Role.length > 0 && !Role.includes(user.role)) { ... }

```

- ржПржЗ ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░ржЯрж┐ ржбрж╛ржЗржирж╛ржорж┐ржХред ржпрзЗржоржи: `authGuard('ADMIN')` рж▓рж┐ржЦрж▓рзЗ ржПржЯрж┐ ржЪрзЗржХ ржХрж░ржмрзЗ ржЗржЙржЬрж╛рж░рзЗрж░ рж░рзЛрж▓ 'ADMIN' ржХрж┐ ржирж╛ред ржпржжрж┐ ржЗржЙржЬрж╛рж░рзЗрж░ рж░рзЛрж▓ ржЕржирзБржорзЛржжрж┐ржд рж░рзЛрж▓рзЗрж░ рждрж╛рж▓рж┐ржХрж╛рзЯ ржирж╛ ржерж╛ржХрзЗ, рждржмрзЗ **403 Forbidden** ржПрж░рж░ ржжрзЗржмрзЗред

### рзм. рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗ ржЗржЙржЬрж╛рж░ ржбрж╛ржЯрж╛ ржпрзБржХрзНржд ржХрж░рж╛ (Attach to req)

```ts
req.user = user;
next();
```

рж╕ржм ржЪрзЗржХ ржкрж╛рж╕ ржХрж░рж▓рзЗ ржЗржЙржЬрж╛рж░рзЗрж░ рждржерзНржп `req.user` ржП рж╕рзЗржн ржХрж░рзЗ рж░рж╛ржЦрж╛ рж╣рзЯ ржпрж╛рждрзЗ ржкрж░ржмрж░рзНрждрзА ржлрж╛ржВрж╢ржи ржмрж╛ ржХржирзНржЯрзНрж░рзЛрж▓рж╛рж░ржЧрзБрж▓рзЛ ржмрзБржЭрждрзЗ ржкрж╛рж░рзЗ ржХрзЛржи ржЗржЙржЬрж╛рж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯржЯрж┐ ржкрж╛ржарж┐рзЯрзЗржЫрзЗред рж╕ржмрж╢рзЗрж╖рзЗ `next()` ржХрж▓ ржХрж░рзЗ ржкрж░рзЗрж░ ржзрж╛ржкрзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯред

# _тЬЕ 2) Express Request ржЯрж╛ржЗржк ржмрж╛рзЬрж╛ржирзЛ (req.user ржЯрж╛ржЗржк ржбрж┐ржХрзНрж▓рзЗрзЯрж╛рж░)_

**ржХрзЗржи ржПржЯрж┐ ржХрж░рж╛ рж╣рзЯ?**

- Express-ржПрж░ ржбрж┐ржлрж▓рзНржЯ Request ржЕржмржЬрзЗржХрзНржЯрзЗрж░ ржоржзрзНржпрзЗ user ржирж╛ржорзЗ ржХрзЛржирзЛ ржкрзНрж░ржкрж╛рж░рзНржЯрж┐ ржерж╛ржХрзЗ ржирж╛ред ржХрж┐ржирзНрждрзБ ржпржЦржи ржЕржерзЗржирзНржЯрж┐ржХрзЗрж╢ржи ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░ (Authentication Middleware) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯ , рждржЦржи ржЯрзЛржХрзЗржи ржнрзЗрж░рж┐ржлрж╛ржЗ ржХрж░рж╛рж░ ржкрж░ ржЗржЙржЬрж╛рж░рзЗрж░ рждржерзНржп req.user ржП рж░рж╛ржЦрждрзЗ рж╣рзЯ ред ржЯрж╛ржЗржкрж╕рзНржХрзНрж░рж┐ржкрзНржЯ (TypeScript) ржПрждрзЗ ржПрж░рж░ ржжрзЗрзЯ ржХрж╛рж░ржг рж╕рзЗ req.user ржЪрзЗржирзЗ ржирж╛ред

- ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ (рж╕ржорзНржнрж╛ржмрзНржп ржХрзЛржб): рж╕рж╛ржзрж╛рж░ржгржд ржПржХржЯрж┐ types.d.ts ржлрж╛ржЗрж▓рзЗ ржПржнрж╛ржмрзЗ рж▓рж┐ржЦрж╛ рж╣рзЯ:

```ts
// src/types/express.d.ts
import { User } from "@prisma/client";

declare global {
  namespace Express {
    interface Request {
      user?: User;
    }
  }
}
```

- ржмрзНржпрж╛ржЦрзНржпрж╛:
  ржПржЯрж┐ ржЯрж╛ржЗржкрж╕рзНржХрзНрж░рж┐ржкрзНржЯржХрзЗ ржмрж▓рзЗ ржжрзЗрзЯ ржпрзЗ, "ржжрзЗржЦрзЛ, ржПржХрзНрж╕ржкрзНрж░рзЗрж╕рзЗрж░ ржпрзЗ Request ржЯрж╛ржЗржк ржЖржЫрзЗ, рждрж╛рж░ ржнрзЗрждрж░рзЗ user ржирж╛ржорзЗржУ ржПржХржЯрж┐ ржлрж┐рж▓рзНржб ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗред"
  ржПрж░ ржлрж▓рзЗ ржпржЦржи ржХржирзНржЯрзНрж░рзЛрж▓рж╛рж░рзЗрж░ ржнрзЗрждрж░ req.user.id рж▓рж┐ржЦрж╛ рж╣ржмрзЗ, рждржЦржи ржЯрж╛ржЗржкрж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржЖрж░ ржХрзЛржирзЛ ржПрж░рж░ ржжрзЗржмрзЗ ржирж╛ ржПржмржВ ржЕржЯрзЛ-рж╕рж╛ржЬрзЗрж╢ржи ржжрзЗржЦрж╛ржмрзЗред

---

# _тЬЕ 3) Usage in Routes ржЙржжрж╛рж╣рж░ржг_

```ts
// src/routes/user.routes.ts
import express from "express";
import { authGuard } from "../middleware/authGuard";
import { userController } from "../controllers/user.controller";

const router = express.Router();

router.delete(
  "/delete-system-logs",
  authGuard("super_admin"),
  userController.deleteLogs
);

router.patch(
  "/update-article/:id",
  authGuard("admin", "editor"),
  userController.updateArticle
);

router.get("/me", authGuard(), userController.getMe);

export default router;
```

# _4) `checkRedisBlacklist()` ржлрж╛ржВрж╢ржи_

```ts
// src/utils/redis.ts
import { createClient } from "redis";

export const redis = createClient({
  url: process.env.REDIS_URL,
});

redis.connect(); // ржПржЯрж╛ржХрзЗ server.ts ржПрж░ ржнрж┐рждрж░ connect ржХрж░рж╛ рж╣рзЯ

export async function checkRedisBlacklist(token: string): Promise<boolean> {
  const exists = await redis.get(`blacklist:${token}`);
  return exists ? true : false;
}

export async function addToBlacklist(token: string) {
  // ржЯрзЛржХрзЗржирзЗрж░ expiry ржХржо рж╣рж▓рзЗ Redis TTL рж╕рзЗржЗ ржЕржирзБржпрж╛рзЯрзА рж╕рзЗржЯ ржХрж░рждрзЗ рж╣ржмрзЗ
  await redis.set(`blacklist:${token}`, "true", { EX: 60 * 60 * 24 }); // 24 hours
}
```

### рзз. Redis ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ рж╕рзЗржЯржЖржк (Initialization)

```ts
export const redis = createClient({
  url: process.env.REDIS_URL,
});

redis.connect();
```

- **ржХрж╛ржЬ:** ржПржЦрж╛ржирзЗ `redis` рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржерзЗржХрзЗ `createClient` ржлрж╛ржВрж╢ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржПржХржЯрж┐ ржХрж╛ржирзЗржХрж╢ржи ржЕржмржЬрзЗржХрзНржЯ рждрзИрж░рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред
- **URL:** `process.env.REDIS_URL` ржПрж░ ржорж╛ржзрзНржпржорзЗ рж░рзЗржбрж┐рж╕ рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ ржарж┐ржХрж╛ржирж╛ (ржпрзЗржоржи: `redis://localhost:6379`) ржирзЗржУрзЯрж╛ рж╣ржЪрзНржЫрзЗред
- **Connect:** `redis.connect()` ржХрж▓ ржХрж░рж╛рж░ ржорж╛ржзрзНржпржорзЗ Node.js ржЕрзНржпрж╛ржкржЯрж┐ рж░рзЗржбрж┐рж╕ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ рж╢рзБрж░рзБ ржХрж░рзЗред

---

### рзи. ржЯрзЛржХрзЗржи ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯ ржЪрзЗржХ ржХрж░рж╛ (Check Blacklist)

```ts
export async function checkRedisBlacklist(token: string): Promise<boolean> {
  const exists = await redis.get(`blacklist:${token}`);
  return exists ? true : false;
}
```

- **ржЙржжрзНржжрзЗрж╢рзНржп:** ржпржЦржиржЗ ржХрзЛржирзЛ ржЗржЙржЬрж╛рж░ ржХрзЛржирзЛ рж╕рж┐ржХрж┐ржЙрж░ рж░рж╛ржЙржЯрзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛ржмрзЗ, ржПржЗ ржлрж╛ржВрж╢ржиржЯрж┐ ржжрж┐рзЯрзЗ ржЪрзЗржХ ржХрж░рж╛ рж╣ржмрзЗ ржпрзЗ рж╕рзЗржЗ ржЯрзЛржХрзЗржиржЯрж┐ "ржмрж╛рждрж┐рж▓" ржмрж╛ "ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗржб" ржХрж┐ ржирж╛ред
- **ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ:** ржПржЯрж┐ рж░рзЗржбрж┐рж╕рзЗ `blacklist:${token}` ржирж╛ржорзЗ ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржЖржЫрзЗ ржХрж┐ ржирж╛ рждрж╛ ржЦрзЛржБржЬрзЗред
- ржпржжрж┐ ржбрж╛ржЯрж╛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ (ржЕрж░рзНржерж╛рзО ржЗржЙржЬрж╛рж░ ржЖржЧрзЗ рж▓ржЧржЖржЙржЯ ржХрж░рзЗржЫрзЗ), рждржмрзЗ ржПржЯрж┐ `true` ржкрж╛ржарж╛ржмрзЗред
- ржпржжрж┐ ржирж╛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ, рждржмрзЗ `false` ржкрж╛ржарж╛ржмрзЗред

---

### рзй. ржЯрзЛржХрзЗржи ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗ ржпрзБржХрзНржд ржХрж░рж╛ (Add to Blacklist)

```ts
export async function addToBlacklist(token: string) {
  await redis.set(`blacklist:${token}`, "true", { EX: 60 * 60 * 24 });
}
```

- **ржЙржжрзНржжрзЗрж╢рзНржп:** ржПржЯрж┐ ржорзВрж▓ржд рж▓ржЧржЖржЙржЯ ржлрж╛ржВрж╢ржирзЗрж░ рж╕ржорзЯ ржмрзНржпржмрж╣рзГржд рж╣рзЯред
- **TTL (Time To Live):** ржПржЦрж╛ржирзЗ `{ EX: 60 * 60 * 24 }` ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗред ржПрж░ ржорж╛ржирзЗ рж╣рж▓рзЛ рж░рзЗржбрж┐рж╕рзЗ ржПржЗ ржЯрзЛржХрзЗржиржЯрж┐ ржорж╛рждрзНрж░ **рзирзк ржШржгрзНржЯрж╛** ржерж╛ржХржмрзЗред рзирзк ржШржгрзНржЯрж╛ ржкрж░ рж░рзЗржбрж┐рж╕ ржЕржЯрзЛржорзЗржЯрж┐ржХ ржПржЗ ржбрж╛ржЯрж╛ржЯрж┐ ржбрж┐рж▓рж┐ржЯ ржХрж░рзЗ ржжрзЗржмрзЗред
- **ржХрзЗржи ржПржЯрж┐ ржжрж░ржХрж╛рж░:** ржЗржЙржЬрж╛рж░рзЗрж░ JWT ржЯрзЛржХрзЗржи ржпржжрж┐ рзирзк ржШржгрзНржЯрж╛ ржорзЗрзЯрж╛ржжрзЗрж░ рж╣рзЯ, рждржмрзЗ рзирзк ржШржгрзНржЯрж╛ ржкрж░ ржЯрзЛржХрзЗржиржЯрж┐ ржПржоржирж┐рждрзЗржЗ ржЕржХрзЗржЬрзЛ рж╣рзЯрзЗ ржпрж╛ржмрзЗред рждрж╛ржЗ рж░рзЗржбрж┐рж╕рзЗ ржПржЯрж┐ ржЖржЬрзАржмржи ржЬржорж┐рзЯрзЗ рж░рж╛ржЦрж╛рж░ ржкрзНрж░рзЯрзЛржЬржи ржирзЗржЗред ржПрждрзЗ ржорзЗржорзЛрж░рж┐ рж╕рж╛рж╢рзНрж░рзЯ рж╣рзЯред

---

### ржПржЗ ржкрзБрж░рзЛ рж╕рж┐рж╕рзНржЯрзЗржоржЯрж┐ ржХрзЗржи ржжрж░ржХрж╛рж░? (Summary)

JWT ржЯрзЛржХрзЗржи ржПржХржмрж╛рж░ ржЗрж╕рзНржпрзБ ржХрж░рж▓рзЗ рждрж╛ рж╕рж╛рж░рзНржнрж╛рж░ ржерзЗржХрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржбрж┐рж▓рж┐ржЯ ржХрж░рж╛ ржпрж╛рзЯ ржирж╛ (Stateless)ред рждрж╛ржЗ ржЗржЙржЬрж╛рж░ ржпржжрж┐ рж▓ржЧржЖржЙржЯржУ ржХрж░рзЗ, рждрж╛рж░ ржЯрзЛржХрзЗржиржЯрж┐ ржжрж┐рзЯрзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛рж▓рзЗ рж╕рж╛рж░рзНржнрж╛рж░ рждрж╛ ржЧрзНрж░рж╣ржг ржХрж░ржмрзЗред ржПржЗ рж╕ржорж╕рзНржпрж╛ рж╕ржорж╛ржзрж╛ржирзЗрж░ ржЬржирзНржп:

1. ржЗржЙржЬрж╛рж░ рж▓ржЧржЖржЙржЯ ржХрж░рж▓рзЗ рждрж╛рж░ ржЯрзЛржХрзЗржиржЯрж┐ **Redis**-ржП рж╕рзЗржн ржХрж░рзЗ рж░рж╛ржЦрж╛ рж╣рзЯред
2. ржкрж░ржмрж░рзНрждрзА ржкрзНрж░рждрж┐ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗ ржЪрзЗржХ ржХрж░рж╛ рж╣рзЯ ржЯрзЛржХрзЗржиржЯрж┐ рж░рзЗржбрж┐рж╕рзЗ ржЖржЫрзЗ ржХрж┐ ржирж╛ред
3. ржпржжрж┐ ржерж╛ржХрзЗ, рждржмрзЗ рждрж╛ржХрзЗ **"Unauthorized"** рж╣рж┐рж╕рзЗржмрзЗ ржмрзНрж▓ржХ ржХрж░рзЗ ржжрзЗржУрзЯрж╛ рж╣рзЯред

---

# _тЬЕ 5) Logout ржХрж░рзЗ ржЯрзЛржХрзЗржи blacklist ржХрж░рж╛_

```ts
// src/controllers/auth.controller.ts
import { Request, Response } from "express";
import { addToBlacklist } from "../utils/redis";

export const logout = async (req: Request, res: Response) => {
  try {
    const token = req.headers.authorization?.split(" ")[1];
    if (token) await addToBlacklist(token);

    res.json({
      success: true,
      message: "Logged out successfully! | рж╕ржлрж▓ржнрж╛ржмрзЗ рж▓ржЧржЖржЙржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ!",
    });
  } catch (e) {
    res
      .status(500)
      .json({ success: false, message: "Logout failed! | рж▓ржЧржЖржЙржЯ ржмрзНржпрж░рзНрже!" });
  }
};
```

- ржирж┐ржЪрзЗ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ ржПрж░ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ:

### рзз. ржЯрзЛржХрзЗржи рж╕ржВржЧрзНрж░рж╣ (Token Extraction)

```ts
const token = req.headers.authorization?.split(" ")[1];
```

ржЗржЙржЬрж╛рж░ ржпржЦржи рж▓ржЧржЖржЙржЯ ржХрж░рждрзЗ ржЪрж╛рзЯ, рждрж╛ржХрзЗ рждрж╛рж░ **JWT Token** ржЯрж┐ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзЗржбрж╛рж░рзЗ ржкрж╛ржарж╛рждрзЗ рж╣рзЯред ржХрзЛржбржЯрж┐ `Authorization` рж╣рзЗржбрж╛рж░ ржерзЗржХрзЗ `Bearer <token>` ржлрж░ржорзНржпрж╛ржЯ ржерзЗржХрзЗ рж╢рзБржзрзБ ржЖрж╕рж▓ ржЯрзЛржХрзЗржиржЯрж┐ (`split(" ")[1]`) ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗ ржирзЗрзЯред

### рзи. ржЯрзЛржХрзЗржи ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯ ржХрж░рж╛ (Blacklisting)

```ts
if (token) await addToBlacklist(token);
```

ржПржЯрж┐ржЗ ржПржЗ ржХрзЛржбрзЗрж░ рж╕ржмржЪрзЗрзЯрзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржЕржВрж╢ред

- **рж╕ржорж╕рзНржпрж╛:** JWT ржЯрзЛржХрзЗржи рж╕рж╛ржзрж╛рж░ржгржд 'Stateless'ред ржЕрж░рзНржерж╛рзО ржПржХржмрж╛рж░ рждрзИрж░рж┐ рж╣рж▓рзЗ ржорзЗрзЯрж╛ржжрзЗрж░ ржЖржЧрзЗ ржПржЯрж┐ ржирж┐ржЬрзЗ ржерзЗржХрзЗ ржирж╖рзНржЯ рж╣рзЯ ржирж╛ред ржЗржЙржЬрж╛рж░ рж▓ржЧржЖржЙржЯ ржХрж░рж╛рж░ ржкрж░ржУ ржпржжрж┐ ржХрзЗржЙ ржЯрзЛржХрзЗржиржЯрж┐ ржЪрзБрж░рж┐ ржХрж░рзЗ, рж╕рзЗ рж╕рзЗржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗред
- **рж╕ржорж╛ржзрж╛ржи:** ржПржЦрж╛ржирзЗ `addToBlacklist(token)` ржлрж╛ржВрж╢ржиржЯрж┐ ржХрж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред ржПржЯрж┐ ржЯрзЛржХрзЗржиржЯрж┐ржХрзЗ ржирж┐рзЯрзЗ **Redis** ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржЬржорж╛ ржХрж░рзЗ рж░рж╛ржЦрзЗред ржЖржорж╛ржжрзЗрж░ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржЕржирзНржп ржЕржВрж╢ (ржпрзЗржоржи `authGuard`) ржкрзНрж░рждрж┐ржмрж╛рж░ ржЪрзЗржХ ржХрж░ржмрзЗ ржпрзЗ ржЯрзЛржХрзЗржиржЯрж┐ рж░рзЗржбрж┐рж╕рзЗрж░ ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯрзЗ ржЖржЫрзЗ ржХрж┐ ржирж╛ред ржерж╛ржХрж▓рзЗ рждрж╛ржХрзЗ ржЖрж░ ржврзБржХрждрзЗ ржжрзЗржмрзЗ ржирж╛ред

---

### рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк: ржПржЗ ржХрзЛржбржЯрж┐ ржХрзЗржи рж╕рзЗрж░рж╛?

- **ржирж┐рж░рж╛ржкрждрзНрждрж╛:** ржЗржЙржЬрж╛рж░ рж▓ржЧржЖржЙржЯ ржХрж░рж╛рж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ рждрж╛рж░ ржЯрзЛржХрзЗржиржЯрж┐ ржЕржХрзЗржЬрзЛ рж╣рзЯрзЗ ржпрж╛ржЪрзНржЫрзЗред
- **ржЧрждрж┐:** Redis ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛рж░ ржХрж╛рж░ржгрзЗ ржмрзНрж▓рзНржпрж╛ржХрж▓рж┐рж╕рзНржЯ ржЪрзЗржХ ржХрж░рж╛рж░ ржХрж╛ржЬржЯрж┐ ржЪрзЛржЦрзЗрж░ ржкрж▓ржХрзЗржЗ (ржорж┐рж▓рж┐рж╕рзЗржХрзЗржирзНржбрзЗ) рж╕ржорзНржкржирзНржи рж╣рзЯред
- **ржкрж░рж┐ржЪрзНржЫржирзНржирждрж╛:** ржЦрзБржм ржЕрж▓рзНржк рж▓рж╛ржЗржирзЗ ржПржХржЯрж┐ ржЬржЯрж┐рж▓ рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ ржорзЗржХрж╛ржирж┐ржЬржо рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред

* ржпржжрж┐ ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ ржзрж░рж╛ ржкрзЬрзЗ тЖТ Middleware ржПржЦрж╛ржирзЗржЗ рж░рзЗрж╕ржкржирзНрж╕ ржжрж┐рзЯрзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржмржирзНржз ржХрж░рзЗ ржжрзЗрзЯ, **next() ржХрж▓ рж╣рзЯ ржирж╛**ред

---

## ЁЯТб ржоржирзЗ рж░рж╛ржЦрж╛рж░ ржмрж┐рж╖рзЯрж╕ржорзВрж╣ (Tips)

- **Always use `next()`**
  рж╕ржмржХрж┐ржЫрзБ ржарж┐ржХ ржерж╛ржХрж▓рзЗ ржЕржмрж╢рзНржпржЗ `next()` ржХрж▓ ржХрж░рждрзЗ рж╣ржмрзЗред
  ржирж╛рж╣рж▓рзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржЖржЯржХрзЗ ржерж╛ржХржмрзЗред

- **Keep it Simple**
  ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░рзЗ ржЦрзБржм ржЬржЯрж┐рж▓ Business Logic рж▓рж┐ржЦрзЛ ржирж╛ред
  ржПржЦрж╛ржирзЗ рж╢рзБржзрзБ ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржУ ржкрзНрж░рж┐-ржЪрзЗржХ рж░рж╛ржЦржмрзЗред

- **Fail Fast Strategy**
  ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ ржкрзЗрж▓рзЗ рж╕ржЩрзНржЧрзЗ рж╕ржЩрзНржЧрзЗ Error рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗред
  ржПрждрзЗ рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ рж▓рзЛржб ржХржорзЗ ржпрж╛рзЯред

---

## тЬФя╕П ржЙржкрж╕ржВрж╣рж╛рж░

Middleware рж╣рж▓рзЛ ржкрзБрж░рзЛ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ тАЬржкрзНрж░ржержо ржирж┐рж░рж╛ржкрждрзНрждрж╛ рж╕рзНрждрж░редтАЭ
ржПржЯрж┐ ржЫрж╛рзЬрж╛ API ржмрж╛ Backend ржХржЦржиржЗ ржирж┐рж░рж╛ржкржж ржерж╛ржХрзЗржирж╛ред
рж╕ржарж┐ржХ Middleware рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржиржХрзЗ ржжрзНрж░рзБржд, ржирж┐рж░рж╛ржкржж ржУ ржорзЗржЗржирзНржЯрзЗржЗржирзЗржмрж▓ ржХрж░рзЗред
