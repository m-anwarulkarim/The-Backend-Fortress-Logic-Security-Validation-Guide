# üõ°Ô∏è Middlewares Layer (‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ì ‡¶™‡¶æ‡¶π‡¶æ‡¶∞‡¶æ‡¶¶‡¶æ‡¶∞ ‡¶∏‡ßç‡¶§‡¶∞)

## üìå ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø

‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶π‡¶≤‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø **"‡¶ö‡ßá‡¶ï‡¶™‡ßã‡¶∏‡ßç‡¶ü"**‡•§ ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü **Controller**-‡¶è ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶è‡¶á ‡¶∏‡ßç‡¶§‡¶∞ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶∞‡ßá‡•§ ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶π‡¶≤‡ßã‚Äî

- ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ
- ‡¶≠‡ßÅ‡¶≤/‡¶Ö‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ
- ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡¶ï‡ßá ‡¶Ö‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶≤‡ßã‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ

‡¶®‡¶ø‡¶ö‡ßá Auth Guard ‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡ß≠‡¶ü‡¶ø ‡¶ß‡¶æ‡¶™ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡ßá ‡¶§‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã (‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®):

---

## üîê Auth Guard-‡¶è‡¶∞ ‡ß≠‡¶ü‡¶ø ‡¶ß‡¶æ‡¶™

1. **‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (Token Extraction)**  
   ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡ßá‡¶∞ `Authorization: Bearer <token>` ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ‡•§

2. **‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶ö‡ßá‡¶ï (Presence Check)**  
   ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§  
   **Status:** `401 Unauthorized`

3. **‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® (Token Verification)**  
   Server-‡¶è‡¶∞ JWT Secret ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶ï‡¶ø ‡¶®‡¶æ‡•§

4. **‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶° ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶ö‡ßá‡¶ï (Blacklist Check)**  
   ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ü‡ßã‡¶ï‡ßá‡¶® Redis-‡¶è‡¶∞ ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡•§  
   ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡•§

5. **‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶∏‡ßç‡¶§‡¶ø‡¶§‡ßç‡¶¨ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á (User Existence Check)**  
   ‡¶ü‡ßã‡¶ï‡ßá‡¶® Valid ‡¶π‡¶≤‡ßá‡¶ì ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡ßü ‡¶Ø‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶ñ‡¶®‡ßã Active ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§

6. **‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (Attach User to Request)**  
   ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï ‡¶π‡¶≤‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø `req.user` ‡¶è ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§

7. **‡¶∞‡ßã‡¶≤-‡¶¨‡ßá‡¶∏‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ (RBAC)**  
   ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ Role (Admin/User/Editor) ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá  
   **Status:** `403 Forbidden`

---

## üßê ‡¶ï‡ßá‡¶® ‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®?

1. **‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ (Authentication)** ‚Äî ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶ø ‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡•§
2. **‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á (Authorization)** ‚Äî ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶õ‡ßá ‡¶§‡¶æ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ‡•§
3. **‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®** ‚Äî ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ/‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡¶ø ‡¶®‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡•§
4. **‡¶ï‡ßã‡¶° ‡¶∞‡¶ø‡¶á‡¶â‡¶ú‡ßá‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø** ‚Äî ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶®‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶è‡¶ï ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡ßü ‡¶∞‡¶æ‡¶ñ‡¶æ‡•§

---

## üö¶ Middleware Workflow

```text
Client Request ‚û°Ô∏è Middleware (‡¶ö‡ßá‡¶ï‡¶™‡ßã‡¶∏‡ßç‡¶ü) ‚û°Ô∏è next() ‚û°Ô∏è Controller
```

# ‚úÖ 1) `checkRedisBlacklist()` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®

```ts
// src/utils/redis.ts
import { createClient } from "redis";

export const redis = createClient({
  url: process.env.REDIS_URL,
});

redis.connect(); // ‡¶è‡¶ü‡¶æ‡¶ï‡ßá server.ts ‡¶è‡¶∞ ‡¶≠‡¶ø‡¶§‡¶∞ connect ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü

export async function checkRedisBlacklist(token: string): Promise<boolean> {
  const exists = await redis.get(`blacklist:${token}`);
  return exists ? true : false;
}

export async function addToBlacklist(token: string) {
  // ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡ßá‡¶∞ expiry ‡¶ï‡¶Æ ‡¶π‡¶≤‡ßá Redis TTL ‡¶∏‡ßá‡¶á ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá
  await redis.set(`blacklist:${token}`, "true", { EX: 60 * 60 * 24 }); // 24 hours
}
```

### ‡ßß. Redis ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ (Initialization)

```ts
export const redis = createClient({
  url: process.env.REDIS_URL,
});

redis.connect();
```

- **‡¶ï‡¶æ‡¶ú:** ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `redis` ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá `createClient` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
- **URL:** `process.env.REDIS_URL` ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶∞‡ßá‡¶°‡¶ø‡¶∏ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶Ø‡ßá‡¶Æ‡¶®: `redis://localhost:6379`) ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
- **Connect:** `redis.connect()` ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá Node.js ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶∞‡ßá‡¶°‡¶ø‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßá‡•§

---

### ‡ß®. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ (Check Blacklist)

```ts
export async function checkRedisBlacklist(token: string): Promise<boolean> {
  const exists = await redis.get(`blacklist:${token}`);
  return exists ? true : false;
}
```

- **‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø:** ‡¶Ø‡¶ñ‡¶®‡¶á ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞ ‡¶∞‡¶æ‡¶â‡¶ü‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá, ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá ‡¶Ø‡ßá ‡¶∏‡ßá‡¶á ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø "‡¶¨‡¶æ‡¶§‡¶ø‡¶≤" ‡¶¨‡¶æ "‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶°" ‡¶ï‡¶ø ‡¶®‡¶æ‡•§
- **‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá:** ‡¶è‡¶ü‡¶ø ‡¶∞‡ßá‡¶°‡¶ø‡¶∏‡ßá `blacklist:${token}` ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ ‡¶§‡¶æ ‡¶ñ‡ßã‡¶Å‡¶ú‡ßá‡•§
- ‡¶Ø‡¶¶‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü (‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá), ‡¶§‡¶¨‡ßá ‡¶è‡¶ü‡¶ø `true` ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡•§
- ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶¨‡ßá `false` ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡•§

---

### ‡ß©. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ (Add to Blacklist)

```ts
export async function addToBlacklist(token: string) {
  await redis.set(`blacklist:${token}`, "true", { EX: 60 * 60 * 24 });
}
```

- **‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø:** ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÇ‡¶≤‡¶§ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡ßü‡•§
- **TTL (Time To Live):** ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `{ EX: 60 * 60 * 24 }` ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶®‡ßá ‡¶π‡¶≤‡ßã ‡¶∞‡ßá‡¶°‡¶ø‡¶∏‡ßá ‡¶è‡¶á ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ **‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ** ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§ ‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶™‡¶∞ ‡¶∞‡ßá‡¶°‡¶ø‡¶∏ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶è‡¶á ‡¶°‡¶æ‡¶ü‡¶æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡ßá‡•§
- **‡¶ï‡ßá‡¶® ‡¶è‡¶ü‡¶ø ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞:** ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ JWT ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶Ø‡¶¶‡¶ø ‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶‡ßá‡¶∞ ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶™‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶è‡¶Æ‡¶®‡¶ø‡¶§‡ßá‡¶á ‡¶Ö‡¶ï‡ßá‡¶ú‡ßã ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶§‡¶æ‡¶á ‡¶∞‡ßá‡¶°‡¶ø‡¶∏‡ßá ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶ú‡ßÄ‡¶¨‡¶® ‡¶ú‡¶Æ‡¶ø‡ßü‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶®‡ßá‡¶á‡•§ ‡¶è‡¶§‡ßá ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø ‡¶∏‡¶æ‡¶∂‡ßç‡¶∞‡ßü ‡¶π‡ßü‡•§

---

### ‡¶è‡¶á ‡¶™‡ßÅ‡¶∞‡ßã ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶ï‡ßá‡¶® ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞? (Summary)

JWT ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶á‡¶∏‡ßç‡¶Ø‡ßÅ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶§‡¶æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü ‡¶®‡¶æ (Stateless)‡•§ ‡¶§‡¶æ‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü‡¶ì ‡¶ï‡¶∞‡ßá, ‡¶§‡¶æ‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡¶æ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶¨‡ßá‡•§ ‡¶è‡¶á ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø:

1. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø **Redis**-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡•§
2. ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶∞‡ßá‡¶°‡¶ø‡¶∏‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§
3. ‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶ï‡ßá **"Unauthorized"** ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡•§

---

# ‚úÖ 2) Prisma ‡¶ï‡ßç‡¶≤‡¶æ‡ßü‡ßá‡¶®‡ßç‡¶ü

```ts
// src/lib/prisma.ts
// ‡¶è‡¶ü‡¶æ prisma ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá
import { PrismaClient } from "@prisma/client";

export const prisma = new PrismaClient();
```

---

# ‚úÖ 3) Express Request ‡¶ü‡¶æ‡¶á‡¶™ ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡ßã (req.user ‡¶ü‡¶æ‡¶á‡¶™ ‡¶°‡¶ø‡¶ï‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞)

**‡¶ï‡ßá‡¶® ‡¶è‡¶ü‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü?**

- Express-‡¶è‡¶∞ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü Request ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá user ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶ø ‡¶•‡¶æ‡¶ï‡ßá ‡¶®‡¶æ‡•§ ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ø‡¶ñ‡¶® ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞ (Authentication Middleware) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü , ‡¶§‡¶ñ‡¶® ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø req.user ‡¶è ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶π‡ßü ‡•§ ‡¶ü‡¶æ‡¶á‡¶™‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü (TypeScript) ‡¶è‡¶§‡ßá ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡ßü ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶∏‡ßá req.user ‡¶ö‡ßá‡¶®‡ßá ‡¶®‡¶æ‡•§

- ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá (‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶ï‡ßã‡¶°): ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø types.d.ts ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶è‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡¶æ ‡¶π‡ßü:

```ts
// src/types/express.d.ts
import { User } from "@prisma/client";

declare global {
  namespace Express {
    interface Request {
      user?: User;
    }
  }
}
```

- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ:
  ‡¶è‡¶ü‡¶ø ‡¶ü‡¶æ‡¶á‡¶™‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡¶ï‡ßá ‡¶¨‡¶≤‡ßá ‡¶¶‡ßá‡ßü ‡¶Ø‡ßá, "‡¶¶‡ßá‡¶ñ‡ßã, ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßç‡¶∞‡ßá‡¶∏‡ßá‡¶∞ ‡¶Ø‡ßá Request ‡¶ü‡¶æ‡¶á‡¶™ ‡¶Ü‡¶õ‡ßá, ‡¶§‡¶æ‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá user ‡¶®‡¶æ‡¶Æ‡ßá‡¶ì ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§"
  ‡¶è‡¶∞ ‡¶´‡¶≤‡ßá ‡¶Ø‡¶ñ‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞ req.user.id ‡¶≤‡¶ø‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá, ‡¶§‡¶ñ‡¶® ‡¶ü‡¶æ‡¶á‡¶™‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶Ü‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶ü‡ßã-‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§

---

# ‚úÖ 4) **‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ Auth Guard Middleware**

```ts
// src/middleware/authGuard.ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";
import { prisma } from "../lib/prisma";
import { checkRedisBlacklist } from "../utils/redis";

export const authGuard = (...Role: string[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      // ‡ßß. Token Extraction
      const token = req.headers.authorization?.split(" ")[1];
      if (!token) throw new Error("You are not logged in! | ‡¶Ü‡¶™‡¶®‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡¶®!");

      // ‡ß®. Blacklist ‡¶ö‡ßá‡¶ï (‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶π‡¶≤‡ßá)
      const isBlacklisted = await checkRedisBlacklist(token);
      if (isBlacklisted)
        throw new Error(  "This token has been revoked! | ‡¶è‡¶á ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");

      // ‡ß©. Token Verify
      const decoded = jwt.verify(
        token,
        process.env.JWT_SECRET as string
      ) as any;

      // ‡ß™. User Exists?
      const user = await prisma.user.findUnique({
        where: { id: decoded.id },
        select: { id: true, role: true, isBanned: true } // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ø‡¶æ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶§‡¶æ ‡¶Ü‡¶®‡ßÅ‡¶®
      });

      if (!user) throw new Error("User not found! | ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
      if (user.isBanned)
        throw new Error( "Your account has been suspended! | ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");

      // ‡ß´. Role Check
      if (Role.length > 0 && !Role.includes(user.role)) {
        return res.status(403).json({
          success: false,
          message: "Access forbidden! You do not have permission | ‡¶è‡¶á ‡¶∞‡ßÅ‡¶ü‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂‡¶æ‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á!",
        });
      }

      // ‡ß¨. Attach user to req
      req.user = user;

      next();
    } catch (error: any) {
      res.status(401).json({
        success: false,
        message: error.message || "Authentication failed! | ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá!",,
      });
    }
  };
};
```

‡¶®‡¶ø‡¶ö‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶è‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã:

---

### ‡ßß. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π (Token Extraction)

```ts
const token = req.headers.authorization?.split(" ")[1];
```

- ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡¶ñ‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡ßü, ‡¶§‡¶ñ‡¶® `Authorization` ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶è‡¶ü‡¶ø `Bearer <token>` ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶á `split(" ")[1]` ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡•§ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶∞‡¶∞ ‡¶•‡ßç‡¶∞‡ßã ‡¶ï‡¶∞‡ßá‡•§

### ‡ß®. ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ö‡ßá‡¶ï (Redis Blacklist Check)

```ts
const isBlacklisted = await checkRedisBlacklist(token);
```

- ‡¶è‡¶ü‡¶ø ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡•§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø Redis-‡¶è ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶•‡¶æ‡¶ï‡ßá‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶Ü‡¶∞ ‡¶¢‡ßÅ‡¶ï‡¶§‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§

### ‡ß©. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® (Token Verify)

```ts
const decoded = jwt.verify(token, process.env.JWT_SECRET as string) as any;
```

- ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `jsonwebtoken` ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶Ø‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶Ü‡¶∏‡¶≤ ‡¶ï‡¶ø ‡¶®‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶π‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶°‡¶ø‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ `id` ‡¶â‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡•§

### ‡ß™. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶∏‡ßç‡¶§‡¶ø‡¶§‡ßç‡¶¨ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á (User Check)

```ts
const user = await prisma.user.findUnique({ ... });

```

- ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶π‡¶≤‡ßá‡¶ì ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶Ø‡ßá ‡¶∏‡ßá‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ü‡¶ø ‡¶è‡¶ñ‡¶®‡¶ì ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§ ‡¶è‡¶ï‡¶á ‡¶∏‡¶æ‡¶•‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ **Banned** ‡¶ï‡¶ø ‡¶®‡¶æ ‡¶§‡¶æ‡¶ì ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§

### ‡ß´. ‡¶∞‡ßã‡¶≤‡ßá ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á (Role Check)

```ts
if (Role.length > 0 && !Role.includes(user.role)) { ... }

```

- ‡¶è‡¶á ‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞‡¶ü‡¶ø ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï‡•§ ‡¶Ø‡ßá‡¶Æ‡¶®: `authGuard('ADMIN')` ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∞‡ßã‡¶≤ 'ADMIN' ‡¶ï‡¶ø ‡¶®‡¶æ‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∞‡ßã‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶∞‡ßã‡¶≤‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá **403 Forbidden** ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá‡•§

### ‡ß¨. ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ (Attach to req)

```ts
req.user = user;
next();
```

‡¶∏‡¶¨ ‡¶ö‡ßá‡¶ï ‡¶™‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø `req.user` ‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶¨‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶¨‡¶∂‡ßá‡¶∑‡ßá `next()` ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá‡¶∞ ‡¶ß‡¶æ‡¶™‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡•§

---

# ‚úÖ 5) Usage in Routes ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£

```ts
// src/routes/user.routes.ts
import express from "express";
import { authGuard } from "../middleware/authGuard";
import { userController } from "../controllers/user.controller";

const router = express.Router();

// ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ super_admin
router.delete(
  "/delete-system-logs",
  authGuard("super_admin"),
  userController.deleteLogs
);

// admin + editor
router.patch(
  "/update-article/:id",
  authGuard("admin", "editor"),
  userController.updateArticle
);

// ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡¶≤‡ßá‡¶á ‡¶π‡¶¨‡ßá
router.get("/me", authGuard(), userController.getMe);

export default router;
```

## ‡¶®‡¶ø‡¶ö‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã:

### ‡ßß. ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∞‡ßã‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø (Super Admin Only)

```ts
router.delete(
  "/delete-system-logs",
  authGuard("super_admin"),
  userController.deleteLogs
);
```

- **‡¶ï‡¶æ‡¶ú:** ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `authGuard` ‡¶è ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ `"super_admin"` ‡¶™‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
- **‡¶´‡¶≤‡¶æ‡¶´‡¶≤:** ‡¶ï‡ßá‡¶â ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶á ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡ßü, ‡¶§‡¶¨‡ßá ‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá ‡¶§‡¶æ‡¶∞ ‡¶∞‡ßã‡¶≤‡ßá `super_admin` ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßá‡¶â (‡¶Ø‡ßá‡¶Æ‡¶®: `admin` ‡¶¨‡¶æ `editor`) ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶Ü‡¶ü‡¶ï‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶¨‡ßá‡•§

### ‡ß®. ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶∞‡ßã‡¶≤‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø (Admin + Editor)

```ts
router.patch(
  "/update-article/:id",
  authGuard("admin", "editor"),
  userController.updateArticle
);
```

- **‡¶ï‡¶æ‡¶ú:** ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `authGuard` ‡¶è ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶∞‡ßã‡¶≤ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: `"admin"` ‡¶è‡¶¨‡¶Ç `"editor"`‡•§
- **‡¶´‡¶≤‡¶æ‡¶´‡¶≤:** ‡¶è‡¶á ‡¶∞‡ßÅ‡¶ü‡ßá ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ `admin` ‡¶è‡¶¨‡¶Ç `editor` ‡¶â‡¶≠‡ßü‡ßá‡¶∞‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§ ‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßã‡¶≤ ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶á ‡¶¶‡ßÅ‡¶ü‡¶ø‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶≠‡ßá‡¶§‡¶∞‡ßá ‡¶¢‡ßÅ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§

### ‡ß©. ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡ßá‡¶ï (Logged-in User Only)

```ts
router.get("/me", authGuard(), userController.getMe);
```

- **‡¶ï‡¶æ‡¶ú:** ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `authGuard()` ‡¶è‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∞‡ßã‡¶≤ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§
- **‡¶´‡¶≤‡¶æ‡¶´‡¶≤:** ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶®‡ßá ‡¶π‡¶≤‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ü‡¶ø‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßã‡¶≤ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶§‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á **‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ** ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶° ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡ßü‡•§

---

### ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π (Visual Representation)

‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶°‡¶æ‡ßü‡¶æ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá `authGuard` ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡¶ü‡¶ø‡¶ï‡ßá ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá:

---

### ‡¶ï‡ßá‡¶® ‡¶è‡¶á ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡¶ü‡¶ø ‡¶∏‡ßá‡¶∞‡¶æ?

| ‡¶¨‡ßà‡¶∂‡¶ø‡¶∑‡ßç‡¶ü‡ßç‡¶Ø      | ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ                                                                                                       |
| -------------- | ------------------------------------------------------------------------------------------------------------ |
| **Reusable**   | ‡¶è‡¶ï‡¶á `authGuard` ‡¶∏‡¶¨ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡•§                                                                |
| **Scalable**   | ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßã‡¶≤ (‡¶Ø‡ßá‡¶Æ‡¶®: `moderator`) ‡¶Ü‡¶∏‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡¶ø‡¶≤‡ßá‡¶á ‡¶π‡¶¨‡ßá‡•§                        |
| **Clean Code** | ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞ ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶∞‡ßã‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ, ‡¶∞‡¶æ‡¶â‡¶ü ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡ßá‡¶á ‡¶¨‡ßã‡¶ù‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶ï‡ßá ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶¢‡ßÅ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§ |

**‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™:**
‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø **Role-Based Access Control (RBAC)** ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡•§ ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßá ‡¶Ø‡ßá:

1. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶ø ‡¶®‡¶æ‡•§
2. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶° ‡¶ï‡¶ø ‡¶®‡¶æ‡•§
3. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßá‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø (Role) ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§

---

# ‚úÖ 6) JWT Token Sign ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£

```ts
// src/utils/jwt.ts
import jwt from "jsonwebtoken";
// ‡¶è‡¶ü‡¶æ ‡¶∏‡¶æ‡¶ß‡¶∞‡¶®‡¶§ login ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶á

export function generateToken(id: string) {
  return jwt.sign({ id }, process.env.JWT_SECRET as string, {
    expiresIn: "1d",
  });
}
```

‡¶®‡¶ø‡¶ö‡ßá ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã:

### ‡ßß. `jwt.sign()` ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶ú

‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶° ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶¨‡¶æ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§ ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡ß©‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá:

- **Payload (`{ id }`):** ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßÄ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡¶®‡•§ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ `id` ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶è‡¶á `id` ‡¶¶‡ßá‡¶ñ‡ßá‡¶á ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶ö‡¶ø‡¶®‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§
- **Secret Key (`process.env.JWT_SECRET`):** ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßã‡¶™‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡•§ ‡¶è‡¶á ‡¶ï‡¶ø (Key) ‡¶õ‡¶æ‡ßú‡¶æ ‡¶ï‡ßá‡¶â ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶¨‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§
- **Options (`{ expiresIn: "1d" }`):** ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶ï‡¶§‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá "1d" ‡¶Æ‡¶æ‡¶®‡ßá ‡¶π‡¶≤‡ßã ‡ßß ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞ ‡¶è‡¶á ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶®‡¶ø‡¶ú‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞ (Expire) ‡¶¨‡¶æ ‡¶Ö‡¶ï‡ßá‡¶ú‡ßã ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§

---

### ‡ß®. ‡¶ï‡ßá‡¶® ‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®? (The Concept)

‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶Ø‡¶æ‡ßü ‡¶ï‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶ö‡ßç‡¶õ‡ßá (Stateless)‡•§ ‡¶§‡¶æ‡¶á ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶è‡¶á ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡ßü‡•§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶∞‡¶™‡¶∞ ‡¶Ø‡¶§‡¶¨‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ö‡¶æ‡¶á‡¶¨‡ßá, ‡¶∏‡ßá ‡¶è‡¶á ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡•§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡¶ñ‡¶® ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ø‡ßá ‡¶è‡¶ü‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡ßá‡¶á ‡¶Ü‡¶∏‡¶≤ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶ï‡¶ø ‡¶®‡¶æ‡•§

---

# ‚úÖ 7) Logout ‡¶ï‡¶∞‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶® blacklist ‡¶ï‡¶∞‡¶æ

```ts
// src/controllers/auth.controller.ts
import { Request, Response } from "express";
import { addToBlacklist } from "../utils/redis";

export const logout = async (req: Request, res: Response) => {
  try {
    const token = req.headers.authorization?.split(" ")[1];
    if (token) await addToBlacklist(token);

    res.json({
      success: true,
      message: "Logged out successfully! | ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!",
    });
  } catch (e) {
    res
      .status(500)
      .json({ success: false, message: "Logout failed! | ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•!" });
  }
};
```

- ‡¶®‡¶ø‡¶ö‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶è‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã:

### ‡ßß. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π (Token Extraction)

```ts
const token = req.headers.authorization?.split(" ")[1];
```

‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶ñ‡¶® ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡ßü, ‡¶§‡¶æ‡¶ï‡ßá ‡¶§‡¶æ‡¶∞ **JWT Token** ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶π‡ßü‡•§ ‡¶ï‡ßã‡¶°‡¶ü‡¶ø `Authorization` ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá `Bearer <token>` ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∏‡¶≤ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø (`split(" ")[1]`) ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡ßá‡ßü‡•§

### ‡ß®. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ (Blacklisting)

```ts
if (token) await addToBlacklist(token);
```

‡¶è‡¶ü‡¶ø‡¶á ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Ö‡¶Ç‡¶∂‡•§

- **‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:** JWT ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ 'Stateless'‡•§ ‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶≤‡ßá ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶ú‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶∑‡ßç‡¶ü ‡¶π‡ßü ‡¶®‡¶æ‡•§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ì ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßá‡¶â ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶ö‡ßÅ‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá, ‡¶∏‡ßá ‡¶∏‡ßá‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§
- **‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®:** ‡¶è‡¶ñ‡¶æ‡¶®‡ßá `addToBlacklist(token)` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá ‡¶®‡¶ø‡ßü‡ßá **Redis** ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßá‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶Ö‡¶Ç‡¶∂ (‡¶Ø‡ßá‡¶Æ‡¶® `authGuard`) ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá ‡¶Ø‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶∞‡ßá‡¶°‡¶ø‡¶∏‡ßá‡¶∞ ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶Ü‡¶∞ ‡¶¢‡ßÅ‡¶ï‡¶§‡ßá ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ‡•§

---

### ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™: ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶ï‡ßá‡¶® ‡¶∏‡ßá‡¶∞‡¶æ?

- **‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ:** ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶§‡¶æ‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶ü‡¶ø ‡¶Ö‡¶ï‡ßá‡¶ú‡ßã ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡•§
- **‡¶ó‡¶§‡¶ø:** Redis ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶ö‡ßã‡¶ñ‡ßá‡¶∞ ‡¶™‡¶≤‡¶ï‡ßá‡¶á (‡¶Æ‡¶ø‡¶≤‡¶ø‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá) ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡•§
- **‡¶™‡¶∞‡¶ø‡¶ö‡ßç‡¶õ‡¶®‡ßç‡¶®‡¶§‡¶æ:** ‡¶ñ‡ßÅ‡¶¨ ‡¶Ö‡¶≤‡ßç‡¶™ ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ú‡¶ü‡¶ø‡¶≤ ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßá‡¶ï‡¶æ‡¶®‡¶ø‡¶ú‡¶Æ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§

* ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶ß‡¶∞‡¶æ ‡¶™‡ßú‡ßá ‚Üí Middleware ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡ßü, **next() ‡¶ï‡¶≤ ‡¶π‡ßü ‡¶®‡¶æ**‡•§

---

## üí° ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∑‡ßü‡¶∏‡¶Æ‡ßÇ‡¶π (Tips)

- **Always use `next()`**
  ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á `next()` ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
  ‡¶®‡¶æ‡¶π‡¶≤‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶Ü‡¶ü‡¶ï‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§

- **Keep it Simple**
  ‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞‡ßá ‡¶ñ‡ßÅ‡¶¨ ‡¶ú‡¶ü‡¶ø‡¶≤ Business Logic ‡¶≤‡¶ø‡¶ñ‡ßã ‡¶®‡¶æ‡•§
  ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø-‡¶ö‡ßá‡¶ï ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá‡•§

- **Fail Fast Strategy**
  ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶™‡ßá‡¶≤‡ßá ‡¶∏‡¶ô‡ßç‡¶ó‡ßá ‡¶∏‡¶ô‡ßç‡¶ó‡ßá Error ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡•§
  ‡¶è‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶Æ‡ßá ‡¶Ø‡¶æ‡ßü‡•§

---

## ‚úîÔ∏è ‡¶â‡¶™‡¶∏‡¶Ç‡¶π‡¶æ‡¶∞

Middleware ‡¶π‡¶≤‡ßã ‡¶™‡ßÅ‡¶∞‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‚Äú‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶∏‡ßç‡¶§‡¶∞‡•§‚Äù
‡¶è‡¶ü‡¶ø ‡¶õ‡¶æ‡ßú‡¶æ API ‡¶¨‡¶æ Backend ‡¶ï‡¶ñ‡¶®‡¶á ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶•‡¶æ‡¶ï‡ßá‡¶®‡¶æ‡•§
‡¶∏‡¶†‡¶ø‡¶ï Middleware ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡¶ï‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§, ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶ì ‡¶Æ‡ßá‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡ßá‡¶¨‡¶≤ ‡¶ï‡¶∞‡ßá‡•§

```


```
